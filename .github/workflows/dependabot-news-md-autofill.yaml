# All PRs into main MUST be deliberately labelled in the NEWS.md with a succint but informative entry
# describing the changes made - this workflow checks to make sure that this has been done.

name: Check NEWS.md Update

on:
  pull_request:
    branches:
      - main

jobs:
  check-news-md-modification:
    name: Check NEWS.md modification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for all tags and branches

      - name: Check for NEWS.md changes
        shell: bash
        run: |
          set -euo pipefail
          echo "Current SHA: $GITHUB_SHA"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"

          git fetch origin ${{ github.event.pull_request.base.ref }}

          CHANGED_FILES=$(git diff --name-only "$GITHUB_SHA" "$(git merge-base "$GITHUB_SHA" "origin/${{ github.event.pull_request.base.ref }}")")
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "NEWS.md"; then
            echo "NEWS.md has been modified."
          else
            echo "::error file=NEWS.md,line=1,col=5::NEWS.md must be updated with each PR." >&2
            exit 1
          fi

  dry-run-dependabot-news-insertion:
    name: Dry-run Dependabot NEWS.md insertion
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Simulate Dependabot NEWS.md insertion
        shell: bash
        run: |
          set -euo pipefail

          ENTRY="* dependabot updating package actions/checkout from version 4 to version 5 new"

          if [[ ! -f NEWS.md ]]; then
            echo "::error::NEWS.md not found"
            exit 1
          fi

          # If entry already exists anywhere, do nothing (idempotent)
          if grep -Fqx "$ENTRY" NEWS.md; then
            echo "NEWS.md already contains the entry. Skipping."
            exit 0
          fi

          tmp="$(mktemp)"

          # Insert directly after the first "## Features" header
          awk -v entry="$ENTRY" '
            BEGIN { inserted=0 }
            {
              print $0
              if ($0 ~ /^##[[:space:]]+Features[[:space:]]*$/ && inserted == 0) {
                print entry
                inserted=1
              }
            }
            END {
              if (inserted == 0) {
                print ""
                print entry
              }
            }
          ' NEWS.md > "$tmp"

          mv "$tmp" NEWS.md

          echo "===== DIFF (expected one new bullet under ## Features) ====="
          git diff || true

          # Assert: entry exists exactly once
          COUNT=$(grep -Fxc "$ENTRY" NEWS.md || true)
          if [[ "$COUNT" -ne 1 ]]; then
            echo "::error::Dependabot NEWS entry not inserted exactly once"
            exit 1
          fi
