name: Start Container App Job
on:
  workflow_dispatch:
defaults:
  run:
    shell: bash -ie {0}

jobs:
  start-caj:
    permissions:
      id-token: 'write'
      packages: 'read'
      contents: 'write'
    runs-on: cfa-cdcgov-aca
    name: start caj
    steps:
      - name: Azure login with OIDC
        id: azure_login_2
        uses: azure/login@v2
        with:
        # managed by EDAV. Contact Amit Mantri or Jon Kislin if you have issues.
          creds: ${{ secrets.EDAV_CFA_PREDICT_NNHT_SP }}

      - name: Trigger job start
        run: |
          CONFIG_FILE="caj-test/configs/cajtest-3-config.json"

          # workaround due to az cli issue: https://github.com/microsoft/azure-container-apps/issues/1360#issuecomment-2652178320
          az containerapp job show \
            --name "cfa-epinow2-test-caj" \
            --resource-group "ext-edav-cfa-prd" \
            --query "properties.template" \
            --output yaml > example-job-template.yaml

          yq eval '.containers[0].command[1] = "$CONFIG_FILE"' example-template.yaml -i

          # start job
          RES=$(az containerapp job start \
          --resource-group  "ext-edav-cfa-prd" \
          --name "cfa-epinow2-test-caj" \
          --yaml example-job-template.yaml)

          JOB_ID=$(echo "$RES" | jq -r '.id' | awk -F/ '{print $NF}')
