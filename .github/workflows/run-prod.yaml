name: make run-prod (or custom)

on:
  schedule:
    - cron: '0 13 * * 3'
  workflow_dispatch:
    inputs:
      command:
        description: The Makefile command to run. Default = make run-prod
        type: string

env:
  COMMAND: ${{ inputs.command || 'make run-prod' }}

jobs:
  run-command:
    permissions:
          id-token: write # This is required for requesting the JWT
          contents: read  # This is required for actions/checkout
    environment: production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        id: checkout_repo
        uses: actions/checkout@v5

      # From: https://stackoverflow.com/a/58035262/2097171
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: get-branch

      # From: https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-cloud-providers#requesting-the-jwt-using-the-actions-core-toolkit
      - name: Install OIDC Client from Core Package
        run: npm install @actions/core@1.6.0 @actions/http-client
      - name: Get Id Token
        uses: actions/github-script@v7
        id: idtoken
        with:
          script: |
            const coredemo = require('@actions/core')
            const id_token = await coredemo.getIDToken('api://AzureADTokenExchange')
            coredemo.setOutput('id_token', id_token)


      - name: Run command
        uses: CDCgov/cfa-actions/runner-action@v1.5.0
        with:
          github_app_id: ${{ secrets.CDCENT_ACTOR_APP_ID }}
          github_app_pem: ${{ secrets.CDCENT_ACTOR_APP_PEM }}
          wait_for_completion: true
          print_logs: true
          script: |
            echo "Logging into Azure CLI"
            az login --service-principal \
            --username ${{ secrets.AZURE_NNHT_SP_CLIENT_ID }} \
            --tenant ${{ secrets.TENANT_ID }} \
            --federated-token ${{ steps.idtoken.outputs.id_token }} \
            --output none

            CURRENT_BRANCH="${{ steps.get-branch.outputs.branch }}"
            echo "Cloning repo at branch '$CURRENT_BRANCH'"
            git clone -b "$CURRENT_BRANCH" https://github.com/${{ github.repository }}.git
            cd cfa-epinow2-pipeline

            echo 'Running command: "${{ env.COMMAND }}"'
            ${{ env.COMMAND }}
